<div class="row">
    <div class="col-md-12">
        <nb-card class="col-md-12 col-lg-12 col-xxxl-12" [nbSpinner]="loading" nbSpinnerStatus="info"
            nbSpinnerSize="giant">
            <nb-card-header>
                <div class="clearfix" *ngIf="factura">
                    <p class="h6 float-left" *ngIf="folio !== '*'">
                        CFDI No {{ factura?.folio }}
                    </p>
                    <nt-invoice-status class="float-right" *ngIf="!!factura?.statusFactura"
                        [status]="factura.statusFactura">
                    </nt-invoice-status>

                    <button nbButton status="success" size="small" (click)="revalidateInvoice()" [nbSpinner]="loading"
                        class="float-right ml-1 mr-1" [disabled]="loading" nbSpinnerStatus="success"
                        *ngIf="factura?.statusFactura == '6' || factura?.statusFactura == '5'" nbSpinnerSize="small"
                        nbSpinnerMessage="">
                        revalidar Factura<i class="fa fa-check" style="margin-left: 10px"></i>
                    </button>
                </div>
            </nb-card-header>
            <nb-card-body>
                <nt-cfdi [allowEdit]="factura?.tipoDocumento !== 'Complemento' && (factura?.folio === undefined ||
                    factura?.statusFactura == 1 || factura?.statusFactura == 2)">
                </nt-cfdi>

                <!--div
                    class="row"
                    *ngIf="
                        factura?.folio !== undefined &&
                        factura?.statusFactura !== '3' &&
                        factura?.statusFactura !== '7'
                    "
                >
                    <div class="col-sm-12" *ngIf="factura">
                        <label for="inputdesc" class="label"
                            >Descripción Rechazo CFDI</label
                        >
                        <input
                            id="statusDetail"
                            class="form-control"
                            fullWidth
                            type="text"
                            placeholder="Motivo rechazo factura"
                            [(ngModel)]="factura?.statusDetail"
                            [disabled]="factura?.statusFactura === '6'"
                        />
                    </div>
                </div-->
                <br />
                <div class="mr" class="buttons-row" *ngIf="factura?.folio !== undefined">
                    <button nbButton status="success" size="medium" (click)="timbrarFactura(factura, dialog)" class="mr-2 ml-2"
                        [nbSpinner]="loading" [disabled]="loading" *ngIf="factura?.statusFactura == '4'"
                        nbSpinnerStatus="success" nbSpinnerSize="small" nbSpinnerMessage="">
                        Timbrar
                    </button>
                    <button class="mr" nbButton status="success" size="medium" (click)="aceptarFactura()" class="mr-2 ml-2"
                        [nbSpinner]="loading" [disabled]="loading" *ngIf="
                            factura?.statusFactura == '1'
                        " nbSpinnerStatus="success" nbSpinnerSize="small" nbSpinnerMessage="">
                        Aceptar
                    </button>

                    <button class="ml" nbButton status="danger" size="medium" (click)="rechazarFactura()" class="mr-2 ml-2"
                        [nbSpinner]="loading" [disabled]="loading" *ngIf="
                            factura?.statusFactura !== '3' &&
                            factura?.statusFactura !== '7' &&
                            factura?.statusFactura !== '6'
                        " nbSpinnerStatus="danger" nbSpinnerSize="small" nbSpinnerMessage="">
                        Rechazar
                    </button>
                    <button class="mr" nbButton status="danger" size="medium" class="mr-2 ml-2"
                        (click)="cancelarFactura(factura, cancelDialog)" [nbSpinner]="loading" [disabled]="loading" 
                        *ngIf="
                            factura?.statusFactura == '3' &&
                            (factura?.tipoDocumento !== 'Complemento' || soporte)
                        " nbSpinnerStatus="danger" nbSpinnerSize="small" nbSpinnerMessage="">
                        Cancelar
                    </button>
                    <button class="mr" nbButton status="warning" size="medium" (click)="linkInvoice(factura)" class="mr-2 ml-2"
                        [nbSpinner]="loading" [disabled]="loading || factura.idCfdiRelacionado" nbSpinnerStatus="danger"
                        nbSpinnerSize="small" nbSpinnerMessage="" *ngIf="
                            factura?.statusFactura === '3' &&
                            factura?.tipoDocumento === 'Factura'
                        ">
                        Sustituir Factura
                    </button>

                    <button class="mr" nbButton status="warning" size="medium" class="mr-2 ml-2"
                        (click)="generateCreditNoteInvoice(factura)" [nbSpinner]="loading"
                        [disabled]="loading || factura?.idCfdiRelacionado" nbSpinnerStatus="danger" nbSpinnerSize="small"
                        nbSpinnerMessage="" *ngIf="
                            factura?.statusFactura === '3' &&
                            factura?.tipoDocumento === 'Factura'
                        ">
                        Nota de crédito
                    </button>
                </div>
                <br />
                
                <div *ngIf="
                        factura?.folio != undefined &&
                        factura?.statusFactura != 'Rechazo Operaciones' &&
                        factura?.statusFactura != 'Cancelada'
                    ">
                    <ngx-pago-factura [factura]="factura" [user]="user" (myEvent)="getInvoiceInfoByPreFolio($event)">
                    </ngx-pago-factura>
                </div>
            </nb-card-body>
        </nb-card>
    </div>
</div>

<ng-template #cancelDialog let-data let-ref="dialogRef">
    <nb-card>
        <nb-card-header>Seleccione motivo de cancelacion</nb-card-header>
        <nb-card-body>
            <div class="row" style="width: 300 px">
                <div class="col-sm-12">
                    <label for="inputMotivo" class="label">Motivo cancelación</label>
                    <select id="inputMotivo" fullWidth class="form-control" style="display: block"
                        [(ngModel)]="data.motivo">
                        <option value="01">
                            Comprobante emitido con errores con relación
                        </option>
                        <option value="02">
                            Comprobante emitido con errores sin relación
                        </option>
                        <option value="03">
                            No se llevó a cabo la operación
                        </option>
                        <option value="04">
                            Operación nominativa relacionada en la factura
                            global
                        </option>
                    </select>
                </div>
                <div class="col-sm-12" *ngIf="data.motivo == '01'">
                    <label for="inputCfdiRelacionado" class="label">UUID relacionado</label>
                    <input id="inputCfdiRelacionado" type="text" [(ngModel)]="data.folioSustituto" fullWidth
                        class="form-control" placeholder="Folio folioSustituto" />
                </div>
            </div>
        </nb-card-body>
        <nb-card-footer>
            <button class="btn btn-warning" (click)="ref.close(undefined)">
                Salir
            </button>
            &nbsp;&nbsp;
            <button class="btn btn-success" (click)="ref.close(data)">
                Cancelar
            </button>
        </nb-card-footer>
    </nb-card>
</ng-template>

<ng-template #dialog let-data let-ref="dialogRef">
    <nb-card>
        <nb-card-header>Seleccione Pack Facturacion</nb-card-header>
        <nb-card-body>
            <div class="row" style="width: 300 px">
                <div class="col-sm-12">
                    <label for="inputGiro" class="label">Pack de facturacion</label>
                    <select id="inputGiro" fullWidth class="form-control" style="display: block"
                        [(ngModel)]="data.packFacturacion">
                        <option value="NTLINK">NT LINK</option>
                    </select>
                </div>
            </div>
        </nb-card-body>
        <nb-card-footer>
            <button class="btn btn-warning" (click)="ref.close(undefined)">
                Salir
            </button>
            &nbsp;&nbsp;
            <button class="btn btn-success" (click)="ref.close(data)">
                Timbrar
            </button>
        </nb-card-footer>
    </nb-card>
</ng-template>